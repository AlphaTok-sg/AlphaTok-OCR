<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Image Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #filePreview img { max-width: 100%; height: auto; }
        #output { white-space: pre-wrap; word-break: break-word; }
        .invoice-table, .items-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        .invoice-table td, .items-table td, .items-table th {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .invoice-table tr:nth-child(even), .items-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .invoice-table tr:hover, .items-table tr:hover {
            background-color: #f1f1f1;
        }
        .invoice-table td:first-child {
            font-weight: bold;
            width: 30%;
        }
        .items-table th {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Intelligent Image Analysis System</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Upload File and Ask Question</h5>
                        <div class="mb-3">
                            <label for="modeSelector" class="form-label">Select Mode</label>
                            <select id="modeSelector" class="form-select">
                                <option value="default">Default Mode</option>
                                <option value="invoice">Invoice Mode</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="questionInput" class="form-label">Question</label>
                            <input type="text" class="form-control" id="questionInput" placeholder="Please enter your question">
                        </div>
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Select Image or PDF</label>
                            <input type="file" class="form-control" id="fileInput" accept="image/*,application/pdf">
                        </div>
                        <button id="submitButton" class="btn btn-primary">Submit</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">File Preview</h5>
                        <div id="filePreview" class="mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Analysis Result 
                            <button id="toggleConfidence" class="btn btn-sm btn-outline-secondary float-end">Show Confidence</button>
                        </h5>
                        <div id="output" class="mt-3 bg-light p-3 rounded"></div>
                        <div id="stats" class="mt-2 text-muted"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script>
        const modeSelector = document.getElementById('modeSelector');
        const questionInput = document.getElementById('questionInput');
        const fileInput = document.getElementById('fileInput');
        const submitButton = document.getElementById('submitButton');
        const outputDiv = document.getElementById('output');
        const filePreview = document.getElementById('filePreview');
        const statsDiv = document.getElementById('stats');
        const toggleConfidenceButton = document.getElementById('toggleConfidence');

        let showConfidence = false;
        let fullResults = [];
        let startTime;
        let characterCount = 0;

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        filePreview.innerHTML = `<img src="${e.target.result}" alt="Image Preview" class="img-fluid rounded">`;
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    filePreview.innerHTML = `<p>PDF File: ${file.name}</p>`;
                    // If PDF preview is needed, PDF.js library can be used to implement it
                }
            } else {
                filePreview.innerHTML = "";
            }
        });

        modeSelector.addEventListener('change', () => {
            if (modeSelector.value === 'invoice') {
                questionInput.value = 'Invoice Analysis';
                questionInput.disabled = true;
            } else {
                questionInput.value = '';
                questionInput.disabled = false;
            }
        });

        toggleConfidenceButton.addEventListener('click', () => {
            showConfidence = !showConfidence;
            toggleConfidenceButton.textContent = showConfidence ? "Hide Confidence" : "Show Confidence";
            updateOutput();
            if (modeSelector.value === 'invoice' && showConfidence === true) {
                try {
                    const resultData = parseInvoiceData(outputDiv.textContent);
                    createInvoiceTable(resultData);
                } catch (error) {
                    console.error('Parsing error:', error);
                    outputDiv.textContent = "Error parsing data: " + error;
                }
            } else {
                // 清除 "Switch to JSON/Table view" 按钮和相关控件
                clearToggleButton();
            }
        });

        function updateOutput() {
            outputDiv.textContent = "";
            characterCount = 0;
            if (modeSelector.value === 'invoice') {
                if (showConfidence) {
                    let meet_quotation_times = 0
                    let begin_record = false
                    let count = 0
                    let temp = 0
                    for (const fullResult of fullResults) {
                        characterCount += fullResult.text.length;
                        outputDiv.textContent += fullResult.text
                        temp += fullResult.confidence
                        count += 1
                        if (fullResult.text.includes(":")) {
                            temp = 0
                            meet_quotation_times = 0
                            begin_record = true
                            count = 0
                        }
                        else if (fullResult.text.includes("\"")) {
                            meet_quotation_times += Array.from(fullResult.text).reduce((count, char) => {
                                return count + (char === "\"")
                            }, 0)
                            if ((meet_quotation_times >= 2) && begin_record) {
                                begin_record = false
                                if (outputDiv.textContent.endsWith("\n")) {
                                    outputDiv.textContent = outputDiv.textContent.slice(0, -1);
                                    outputDiv.textContent += ` (${(temp/count).toFixed(4)})\n`;
                                }
                                else {
                                    outputDiv.textContent += ` (${(temp/count).toFixed(4)})`;
                                }
                            }
                        }
                    }
                }
                else{
                    fullResults.forEach(result => {
                        outputDiv.textContent += result.text;
                        characterCount += result.text.length;
                    });
                }
            }
            else {
                fullResults.forEach(result => {
                outputDiv.textContent += result.text;
                characterCount += result.text.length;
                if (showConfidence && result.confidence !== null) {
                    outputDiv.textContent += ` (${result.confidence.toFixed(4)})`;
                    }
                });
            }
            updateStats();
        }

        function updateStats() {
            const endTime = new Date();
            const responseTime = (endTime - startTime) / 1000;
            statsDiv.textContent = `Character Count: ${characterCount}, Response Time: ${responseTime.toFixed(2)} seconds`;
        }

        submitButton.addEventListener('click', () => {
            // 清除 "Switch to JSON/Table view" 按钮和相关控件
            clearToggleButton();
            
            outputDiv.textContent = "Analyzing, please wait...";
            statsDiv.textContent = "";
            fullResults = [];
            characterCount = 0;
            startTime = new Date();

            let question = questionInput.value;
            const file = fileInput.files[0];

            if (modeSelector.value === 'invoice') {
                const json_format = {
                    "PO_NUMBER": "",
                    "SUBSIDIARY": "",
                    "VENDOR": "",
                    "CURRENCY": "",
                    "REFERENCE NO.": "",
                    "DATE": "",
                    "LOCATION": "",
                    "PAYMENT TERMS": "",
                    "POSTING PERIOD": "",
                    "DUE DATE": "",
                    "DISCOUNT DATE": "",
                    "MEMO": "",
                    "CALCULATED AMOUNT": "",
                    "items": [
                        {
                            "qty": "",
                            "description": "",
                            "unit price": "",
                            "amount": ""
                        }
                    ]
                };
                question = `
                    This is an invoice picture.
                    You should try to fulfill the invoice content in JSON format:
                    ${JSON.stringify(json_format, null, 2)}
                    You should only return the pure JSON format data without any other content.
                `;
            }

            if (!question || !file) {
                alert("Please select a file" + (modeSelector.value === 'default' ? " and enter a question" : ""));
                return;
            }

            const formData = new FormData();
            formData.append('image', file);
            formData.append('question', question);
            fetch('https://caring-hippo-newly.ngrok-free.app/stream', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // 在 readChunk 函数中
                function readChunk() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log("Analysis completed");
                            updateStats();
                            // if (modeSelector.value === 'invoice') {
                            //     try {
                            //         const resultData = parseInvoiceData(outputDiv.textContent);
                            //         createInvoiceTable(resultData);
                            //     } catch (error) {
                            //         console.error('Parsing error:', error);
                            //         outputDiv.textContent = "Error parsing data: " + error;
                            //     }
                            // }
                            return;
                        }
                        const textChunk = decoder.decode(value);
                        const lines = textChunk.split('\n');
                        lines.forEach(line => {
                            if (line.trim()) {
                                const result = JSON.parse(line);
                                fullResults.push(result);
                                updateOutput();
                            }
                        });
                        readChunk(); 
                    });
                }

                readChunk();
            })
            .catch(error => {
                console.error('Error:', error);
                outputDiv.textContent = "An error occurred: " + error;
            });
        });

        function parseInvoiceData(dataStr) {
            const result = {};
            let currentItem = null;
            let inItemsArray = false;

            // 将输入字符串拆分为行
            const lines = dataStr.trim().split('\n');

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                // if (line === '{' || line === '}') {
                //     // 跳过对象的起始和结束符
                //     continue;
                // }

                if (line.startsWith('"items":')) {
                    inItemsArray = true;
                    result['items'] = [];
                    continue;
                }

                if (inItemsArray) {
                    if (line === '[' || line === ']' || line === '],') {
                        // 跳过数组的起始和结束符
                        continue;
                    }
                    if (line === '{') {
                        // 开始新的 item 对象
                        currentItem = {};
                        continue;
                    }
                    if (line === '},' || line === '}') {
                        // 结束当前 item 对象
                        if (currentItem && Object.keys(currentItem).length > 0) {
                            result['items'].push(currentItem);
                        }
                        currentItem = null;
                        continue;
                    }

                    // 解析 item 对象的字段
                    const fieldMatch = line.match(/"([^"]+)":\s*"([^"]*)",?\s*\(([^)]+)\)/);
                    if (fieldMatch) {
                        const key = fieldMatch[1];
                        const value = fieldMatch[2];
                        const confidence = parseFloat(fieldMatch[3]);
                        if (currentItem) {
                            currentItem[key] = { value, confidence };
                        }
                    }
                } else {
                    // 解析非 items 的字段
                    const fieldMatch = line.match(/"([^"]+)":\s*"([^"]*)",?\s*\(([^)]+)\)/);
                    if (fieldMatch) {
                        const key = fieldMatch[1];
                        const value = fieldMatch[2];
                        const confidence = parseFloat(fieldMatch[3]);
                        result[key] = { value, confidence };
                    }
                }
            }

            console.log('Parsed data:', result); // 调试输出
            return result;
        }

        function createInvoiceTable(data) {
            console.log('Data for table:', data); // 调试输出

            const table = document.createElement('table');
            table.className = 'invoice-table';

            for (const [key, obj] of Object.entries(data)) {
                if (key !== 'items') {
                    const row = table.insertRow();
                    const keyCell = row.insertCell(0);
                    const valueCell = row.insertCell(1);

                    keyCell.textContent = key;

                    if (obj && typeof obj === 'object') {
                        const text = obj.value;
                        const confidence = obj.confidence;
                        
                        // 创建一个 span 元素来包装文本
                        const textSpan = document.createElement('span');
                        textSpan.textContent = text;
                        
                        // 设置 title 属性，显示置信度
                        textSpan.title = `confidence: ${confidence.toFixed(4)}`;
                        
                        // 在置信度低于阈值时标记背景色
                        if (confidence < 0.8) {
                            textSpan.style.backgroundColor = 'red';
                        }
                        
                        // 将 span 元素添加到单元格中
                        valueCell.appendChild(textSpan);
                    } else {
                        valueCell.textContent = '';
                    }
                }
            }

            // 处理 items 数组
            // 处理 items 数组
            if (data.items && Array.isArray(data.items)) {
                const itemsTable = document.createElement('table');
                itemsTable.className = 'items-table';

                const headerRow = itemsTable.insertRow();
                ['qty', 'description', 'unit price', 'amount'].forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });

                data.items.forEach(item => {
                    const row = itemsTable.insertRow();
                    ['qty', 'description', 'unit price', 'amount'].forEach(key => {
                        const cell = row.insertCell();
                        const obj = item[key];

                        if (obj && typeof obj === 'object') {
                            const text = obj.value;
                            const confidence = obj.confidence;
                            
                            // 创建一个 span 元素来包装文本
                            const textSpan = document.createElement('span');
                            textSpan.textContent = text;
                            
                            // 设置 title 属性，显示置信度
                            textSpan.title = `confidence: ${confidence.toFixed(4)}`;
                            
                            // 在置信度低于阈值时标记背景色
                            if (confidence < 0.8) {
                                textSpan.style.backgroundColor = 'red';
                            }
                            
                            // 将 span 元素添加到单元格中
                            cell.appendChild(textSpan);
                        } else {
                            cell.textContent = '';
                        }
                    });
                });

                // 将 itemsTable 添加到主表格中
                const itemsRow = table.insertRow();
                const itemsCell = itemsRow.insertCell();
                itemsCell.colSpan = 2;
                itemsCell.appendChild(itemsTable);
            }

            const toggleButton = document.createElement('button');
            toggleButton.textContent = 'Switch to JSON/Table view';
            toggleButton.setAttribute('data-toggle-view', 'true'); // 添加一个属性以便于选择
            toggleButton.onclick = () => {
                if (outputDiv.style.display === 'none') {
                    outputDiv.style.display = 'block';
                    table.style.display = 'none';
                } else {
                    outputDiv.style.display = 'none';
                    table.style.display = 'block';
                }
            };

            outputDiv.parentNode.insertBefore(toggleButton, outputDiv.nextSibling);
            outputDiv.parentNode.insertBefore(table, toggleButton.nextSibling);
            table.style.display = 'none';
        }

        // 添加新的函数来清除 "Switch to JSON/Table view" 按钮和相关控件
        function clearToggleButton() {
            const toggleButton = document.querySelector('button[data-toggle-view]');
            if (toggleButton) {
                toggleButton.remove();
            }
            const table = document.querySelector('.invoice-table');
            if (table) {
                table.remove();
            }
            outputDiv.style.display = 'block';
        }
    </script>
</body>
</html>
